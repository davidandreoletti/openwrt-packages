#
# Copyright (C) 2006-2016 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

include $(TOPDIR)/rules.mk

PKG_NAME:=owntone
PKG_VERSION:=28.5
PKG_RELEASE:=2

PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.xz
PKG_SOURCE_URL:=https://github.com/owntone/owntone-server/releases/download/$(PKG_VERSION)/
PKG_HASH:=c9ee0152dc488f782a25a68e72d24c109882bef3dd2914315fe499c8415fd898

PKG_FIXUP:=autoreconf
PKG_BUILD_FLAGS:=no-mips16
PKG_INSTALL:=1

PKG_MAINTAINER:=Espen JÃ¼rgensen <espenjurgensen+openwrt@gmail.com>
PKG_LICENSE:=GPL-2.0
PKG_LICENSE_FILES:=COPYING

PKG_CONFIG_DEPENDS:= \
	CONFIG_AUDIO_SUPPORT

include $(INCLUDE_DIR)/package.mk
include $(INCLUDE_DIR)/nls.mk

define Package/owntone/default
  SECTION:=sound
  CATEGORY:=Sound
  TITLE:=iTunes (DAAP) server for Apple Remote and AirPlay
  URL:=https://github.com/owntone/owntone-server
  DEPENDS:=+libgpg-error +libgcrypt +libgdbm +zlib +libexpat +libunistring \
  	+libevent2 +libdaemon +confuse +alsa-lib +libffmpeg-full \
  	+mxml +libavahi-client +sqlite3-cli +libplist +libcurl +libjson-c \
  	+libprotobuf-c +libgnutls +libsodium +libwebsockets +libuuid $(ICONV_DEPENDS)
  PROVIDES:=owntone
endef

define Package/owntone
  $(Package/owntone/default)
  TITLE+= (original)
  VARIANT:=original
  DEFAULT_VARIANT:=1
endef

define Package/owntone-pulseaudio
  $(Package/owntone/default)
  TITLE+= (with pulseaudio support)
  DEPENDS+= +AUDIO_SUPPORT:pulseaudio
  VARIANT:=pulseaudio
  CONFLICTS:=owntone
endef

define Package/owntone/default/description
  OwnTone is a Linux/FreeBSD DAAP (iTunes), MPD (Music Player Daemon) and
  RSP (Roku) media server. It has support for AirPlay speakers, Chromecast,
  Apple Remote (and compatibles), MPD clients, Spotify, internet radio and
  LastFM. It does not support AirPlay/Chromecast video.
endef
Package/owntone/description = $(Package/owntone/default/description)
Package/owntone-pulseaudio/description = $(Package/owntone/default/description)
 

define Package/owntone/default/conffiles
/etc/owntone.conf
endef
Package/owntone/conffiles = $(Package/owntone/default/conffiles)
Package/owntone-pulseaudio/conffiles = $(Package/owntone/default/conffiles)

CONFIGURE_ARGS += \
	--enable-chromecast \
	--disable-install_systemd \
	--disable-install_conf_file \
	--disable-install_user \
	--with-alsa \
	--without-libevent_pthreads

ifeq ($(BUILD_VARIANT),pulseaudio)
  CONFIGURE_ARGS+= --with-pulseaudio
else
  CONFIGURE_ARGS+= --without-pulseaudio
endif
 
TARGET_CFLAGS += $(FPIC)

ifeq ($(BUILD_VARIANT),pulseaudio)
ifeq ($(CONFIG_AUDIO_SUPPORT),y)
	TARGET_LDFLAGS += -Wl,-rpath-link=$(STAGING_DIR)/usr/lib/pulseaudio
endif
endif

define Package/owntone/default/install
	$(INSTALL_DIR) $(1)/usr/sbin
	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/sbin/owntone $(1)/usr/sbin/
	$(INSTALL_DIR) $(1)/etc
	$(INSTALL_CONF) ./files/owntone.conf $(1)/etc/owntone.conf
	$(INSTALL_DIR) $(1)/usr/lib/owntone
	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/lib/owntone/* $(1)/usr/lib/owntone/
	$(INSTALL_DIR) $(1)/etc/init.d
	$(INSTALL_BIN) ./files/owntone.init $(1)/etc/init.d/owntone
	$(INSTALL_DIR) $(1)/usr/share/owntone
	$(CP) $(PKG_INSTALL_DIR)/usr/share/owntone/htdocs $(1)/usr/share/owntone
endef
Package/owntone/install = $(Package/owntone/default/install)
Package/owntone-pulseaudio/install = $(Package/owntone/default/install)
 
$(eval $(call BuildPackage,owntone))
$(eval $(call BuildPackage,owntone-pulseaudio))
